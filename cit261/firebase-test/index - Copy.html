<!DOCTYPE html>
<html>
<title>Firebase and XHR</title>
<body>

<script>

function armXHRHandler(targetUrl, requestType, setupAndRun, callback) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        callback(null, JSON.parse(xhr.responseText));
      } else {
        callback("Error accessing: " + targetUrl + 
          "\nResponse: " + xhr.status + " " + xhr.responseText, null)
      }
    } 
  };
  setupAndRun(xhr);
}

function signUp(callback) {
  var xhttp = new XMLHttpRequest();
  var targetUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/signupNewUser?key=AIzaSyB8zcwBbFhFlE_NY-qrXsSLjNzet1balk4";
  armXHRHandler(xhttp, targetUrl, callback);
  xhttp.open("POST", targetUrl, true);
  xhttp.send();
}

function getData(auth, callback) {
  var xhttp = new XMLHttpRequest();
  var targetUrl = "https://api-test-7266c.firebaseio.com/users.json?auth=" + auth;
  armXHRHandler(xhttp, targetUrl, callback);
  xhttp.open("GET", targetUrl, true);
  xhttp.send();
}

function postData(auth, data, callback) {
  var xhttp = new XMLHttpRequest();
  var targetUrl = "https://api-test-7266c.firebaseio.com/users.json?auth=" + auth;
  armXHRHandler(xhttp, targetUrl, callback);
  xhttp.open("POST", targetUrl, true);
  xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
  xhttp.send(JSON.stringify(data));
}

signUp(function(err, authObj) {
  if (err) {
    console.log(err);
  } else {
    console.log(authObj);
    var user = {
      firstName: 'John',
      lastName: 'Doe',
      email: 'john.doe@demo.org',
    }
    postData(authObj.idToken, user, function(err, data) {
      if (err) {
        console.log(err);
      } else {
        console.log(data);
        getData(authObj.idToken, function(err, data) {
          if (err) {
            console.log(err);
          } else {
            console.log(data);
          }
        });
      }
    });
  }
});
</script>

</body>

</html>
